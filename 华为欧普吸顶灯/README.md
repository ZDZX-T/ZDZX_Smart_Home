# 华为欧普吸顶灯

## 介绍
我购买的华为欧普智能吸顶灯不支持接入除了华为智慧生活外的任何平台（甚至是欧普照明自己），这对我的智能家居计划造成了极大影响。在尝试抓包、抓链路层包、抓遥控器射频信号无果后，我将目光瞄准了控制盒本身，而且如你所见，我成功了。我的控制盒型号是【OP CM-HWKZH-DTDV-WiFi】，如果你也有相同的困扰，请尝试我的方案吧！  
不过话说在前头，目前版本只能做到完全替换，原装的遥控器和智慧生活将不能再对灯进行控制（当然你可以随时替换回原控制盒）。理想情况是我们自制的控制盒会充当原装控制盒的被控制对象，这样既能使用原遥控器和华为智慧生活，又能将其接入Home Assistant，是最终的方案。  

## 项目文件
核心代码是[HWOPLamp.yaml](../en_path/HWOPLamp.yaml)(位于/en_path内，点击链接可跳转）。如果自己创建配置文件，只复制preferences标签及其之后的内容到你自己的配置文件即可。  
[zdzx-t_hwop.factory.bin](./zdzx-t_hwop.factory.bin)是二进制模板文件，将其直接烧录到你的板子上，理论上ESPHome Builder会从github自动拉取模板文件。
  
[SCH_华为欧普智能吸顶灯_2025-03-02.pdf](./SCH_华为欧普智能吸顶灯_2025-03-02.pdf)是原理图。  
[Gerber_华为欧普智能吸顶灯_2025-03-02.zip](./Gerber_华为欧普智能吸顶灯_2025-03-02.zip)是制板文件。  
[BOM_华为欧普智能吸顶灯_2025-03-02.xlsx](./BOM_华为欧普智能吸顶灯_2025-03-02.xlsx)是BOM清单。  
[3d打印外壳](./3d打印外壳)文件夹内是控制盒的盒，15%填充即可，不需要支撑。

## 使用方法
1. 去嘉立创下(bai)单(piao)制板文件，同时根据BOM清单购买原件备用（注意还需要准备铜管天线，BOM里没写），并3d打印外壳。芯片型号为乐鑫的ESP32-C3-WROOM-02U，雷达模块（BOM未列出）为海凌科的LD2420。板子上的LD2420按需焊接，可以焊排母，也可以直接焊线或其他什么东西。  
2. 焊接。
3. 烧录。这里有两种选择，一是自己创建yaml文件，然后将[HWOPLamp.yaml](../en_path/HWOPLamp.yaml)内的preferences标签及其之后的内容追加到你的yaml文件内；二是直接烧录[zdzx-t_hwop.factory.bin](./zdzx-t_hwop.factory.bin)，ESPHome会尝试从github拉取yaml文件。鉴于国内的网络环境，比较推荐自己创建yaml。  
4. 安装。将吸顶灯原控制盒拆下，换上自己的控制盒，然后进入ESPHome Builder查看log，查看i2c地址是否为0x09，如果不是的话需要进入配置文件，将i2c_device标签的address属性改为刚才扫描到的地址，然后再次INSTALL。如果log显示没有找到i2c设备，那么需要给灯断电，然后重新开灯，并再次查看log，需要重复此过程直到log有i2c设备地址为止。我的经验是可以关灯较长一段时间后再试，也可以先把控制盒拔下来，然后开灯，然后再插入控制盒（此方法注意防止触电）。
  
  
  
### _下方为开发参考内容_  
面向排针

| 上    | 方      | 是   | 螺   | 丝   | 孔  |
|------|--------|-----|-----|-----|----|
|      | MRST_0 | SCL | GND | SDA |    |
| WRST |        |     | GND |     | 5V |
  
  
手机操控：

色温 开 100 2700：W12 08 00 0F D0 07 01 00 00  R13 06 00 10 00 00 00  W12 09 00 13 D0 07 8C 0A 00 00  R13 06 00 14 00 00 00

色温 开 100 5421：W12 08 00 0F D0 07 01 00 00  R13 06 00 10 00 00 00  W12 09 00 13 D0 07 2D 15 00 00  R13 06 00 14 00 00 00

色温 开 100 5700：W12 08 00 0F D0 07 01 00 00  R13 06 00 10 00 00 00  W12 09 00 13 D0 07 44 16 00 00   R13 06 00 14 00 00 00

亮度 开 041 5700：W12 08 00 0F 0D 07 01 00 00  R13 06 00 10 00 00 00  W12 09 00 11 D0 07 04 10 00 00   R13 06 00 12 00 00 00

观影 开 020 3000：W12 08 00 0F D0 07 01 00 00  R13 06 00 10 00 00 00  W12 09 00 11 D0 07 D0 07 00 00  R13 06 00 12 00 00 00  W12 09 00 13 D0 07 B8 0B 00 00  R13 06 00 14 00 00 00


遥控操控：

色温 开 100 2700：W12 09 00 13 D0 07 8C 0A 00 00  R13 06 00 14 00 00 00

色温 开 100 2950：W12 09 00 13 D0 07 86 0B 00 00  R13 06 00 14 00 00 00

色温 开 100 3200：W12 09 00 13 D0 07 80 0C 00 00  R13 06 00 14 00 00 00

亮度 开 100 5700：W12 09 00 11 D0 07 10 27 00 00  R13 06 00 12 00 00 00

亮度 开 092 5700：W12 09 00 11 D0 07 F0 23 00 00  R13 06 00 12 00 00 00

关 100 5700：W12 08 00 0F D0 07 00 00 00  R13 06 00 10 00 00 00

开 100 5700：W12 08 00 0F D0 07 01 00 00  R13 06 00 10 00 00 00  W12 09 00 11 D0 07 10 27 00 00  R13 06 00 12 00 00 00  W12 09 00 13 D0 07 44 16 00 00  R13 06 00 14 00 00 00
